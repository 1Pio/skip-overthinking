---
phase: 05-persistence-auth-and-sync-security
plan: 05
type: execute
wave: 4
depends_on:
  - 05-03
  - 05-04
files_modified:
  - src/app/App.tsx
  - src/app/router.tsx
  - src/app/main.tsx
  - src/features/decision/state/draft.storage.ts
autonomous: true
requirements:
  - SYN-01
  - SYN-02
user_setup: []

must_haves:
  truths:
    - "App is wrapped in AuthProvider for auth context access"
    - "Workspace page is at root route /"
    - "Wizard routes work with auth-aware decision management"
    - "AuthFooter appears in decision pages (not workspace)"
    - "First app launch shows auth choice modal (optional, can sign in anytime)"
    - "Local draft storage integrates with decision management"
  artifacts:
    - path: "src/app/App.tsx"
      provides: "Main app with AuthProvider and router"
      contains: "App"
    - path: "src/app/router.tsx"
      provides: "Router with workspace route and wizard routes"
      contains: "createBrowserRouter"
    - path: "src/app/main.tsx"
      provides: "React app entry point"
      contains: "createRoot"
    - path: "src/features/decision/state/draft.storage.ts"
      provides: "Integrated draft storage with auth-aware persistence"
      contains: "hydrateDraft", "persistDraft"
  key_links:
    - from: "src/app/App.tsx"
      to: "src/features/auth/auth.context.tsx"
      via: "AuthProvider wrapping app"
      pattern: "<AuthProvider>"
    - from: "src/app/router.tsx"
      to: "src/features/workspace/Workspace.tsx"
      via: "workspace route at /"
      pattern: "path: '/', element: <Workspace"
    - from: "src/features/decision/state/draft.storage.ts"
      to: "src/features/auth/storage/local.storage.ts"
      via: "localStorageService for anonymous mode"
      pattern: "localStorageService"
    - from: "src/features/decision/state/draft.storage.ts"
      to: "convex/decisions"
      via: "Convex mutations for authenticated mode"
      pattern: "mutation\\.decisions\\.create"
---

<objective>
Integrate auth context and workspace into app routing with auth-aware draft storage.

Purpose: Complete auth integration (SYN-01, SYN-02) with workspace landing and auth-aware decision persistence.
Output: App wrapped in AuthProvider, workspace at root, wizard routes integrated, and draft storage respecting auth mode.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/auth/auth.context.tsx
@src/features/workspace/Workspace.tsx
@src/features/decision/state/draft.storage.ts
@src/features/decision/state/draft.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update draft storage to be auth-aware</name>
  <files>
    - src/features/decision/state/draft.storage.ts
  </files>
  <action>
    Update src/features/decision/state/draft.storage.ts:

    1. Keep existing functions: hydrateDraft, persistDraft, clearDraft

    2. Add auth-aware storage logic:

    Update persistDraft(draft: DecisionDraft): void
    - Check auth state (need to inject auth dependency or check via context hook - for simplicity, add optional auth parameter)
    - If authenticated (user is signed in):
      - Check if draft has an ID (from existing decision or new)
      - If no ID: Generate new ID using generateDecisionId() from local storage utils
      - Create/update decision in Convex: mutation.decisions.create or mutation.decisions.update
      - Do NOT save to localStorage (cache only, handled by storage-sync-service)
    - If not authenticated:
      - Save to localStorage as before
      - Use existing localStorage key: "skip-overthinking:decision-draft:v1"

    Update hydrateDraft(): DecisionDraft | null
    - Check auth state
    - If authenticated:
      - Load from Convex cache (populated by storage-sync-service)
      - Or return null if no draft
    - If not authenticated:
      - Load from localStorage as before

    3. Add new functions:
    - saveDraftToConvex(draft: DecisionDraft, decisionId?: string): Promise<void>
      - Called when authenticated user saves decision
      - Create or update decision in Convex
    - loadDraftFromConvex(decisionId: string): Promise<DecisionDraft | null>
      - Load decision from Convex for editing

    IMPORTANT: For MVP, keep existing localStorage draft storage for simplicity. The main auth integration is at the workspace level (managing completed decisions). Draft editing can remain localStorage for now, with full Convex sync deferred if needed.

    Actually, per the planning context, the single draft pattern should remain. Let me simplify:

    Keep existing localStorage draft storage unchanged. The auth integration is:
    - Anonymous mode: LocalStorage is source of truth for all decisions (draft and completed)
    - Authenticated mode: Convex is source of truth for completed decisions, localStorage is cache only

    For draft editing in authenticated mode, we can either:
    - Keep using localStorage for drafts (simpler for MVP)
    - Move drafts to Convex too (full sync)

    For Phase 5, let's keep drafts in localStorage for simplicity. The key auth integration is:
    - Workspace manages completed decisions
    - Completed decisions sync to Convex when signed in
    - Drafts remain local (can be saved to Convex as "completed" decisions)

    So minimal changes to draft.storage.ts - just keep existing behavior.
  </action>
  <verify>
    - src/features/decision/state/draft.storage.ts functions still work
    - Existing localStorage draft storage is preserved
    - Drafts continue to persist across sessions
  </verify>
  <done>
    Draft storage remains functional with existing localStorage behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update router to include workspace route</name>
  <files>
    - src/app/router.tsx
  </files>
  <action>
    Update src/app/router.tsx:

    1. Import Workspace from "../../features/workspace"

    2. Add workspace route at root:
    - path: "/"
    - element: <Workspace />

    3. Keep existing wizard routes:
    - /setup/decision
    - /setup/options
    - /criteria
    - /ratings
    - /results

    4. Update wizard routes to be under /decision/:id? (optional, for decision-specific routes)
    - For MVP, keep existing routes unchanged
    - When user clicks a decision card in workspace, navigate to /setup/options with draft pre-loaded from that decision

    5. Decision card click handler (in Workspace component) should:
    - Load decision from localStorage or Convex
    - Restore to DraftProvider state
    - Navigate to appropriate route (e.g., /setup/options or /criteria depending on decision completeness)

    IMPORTANT: For MVP simplicity, keep existing wizard routes unchanged. When user clicks a decision card:
    - Load decision data
    - Initialize DraftProvider with that data
    - Navigate to /setup/options (or appropriate step)

    The key change is adding the workspace route at root.
  </action>
  <verify>
    - src/app/router.tsx has workspace route at "/"
    - Existing wizard routes are preserved
    - Workspace route is the default landing page
  </verify>
  <done>
    Router includes workspace route at root with existing wizard routes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wrap app in AuthProvider</name>
  <files>
    - src/app/App.tsx
  </files>
  <action>
    Update src/app/App.tsx:

    1. Import AuthProvider from "../features/auth/auth.context"

    2. Wrap the entire app in AuthProvider:
    - Existing: <RouterProvider router={router} />
    - Updated: <AuthProvider><RouterProvider router={router} /></AuthProvider>

    3. Keep existing DraftProvider (should remain inside RouterProvider)

    4. The structure should be:
    - AuthProvider (wraps everything for auth context)
      - RouterProvider
        - DraftProvider (already in routes)
          - Wizard routes, workspace, etc.

    IMPORTANT: AuthProvider must wrap RouterProvider so all routes have access to auth context.
  </action>
  <verify>
    - src/app/App.tsx imports AuthProvider
    - AuthProvider wraps RouterProvider
    - Auth context is available to all routes
    - DraftProvider remains in place within routes
  </verify>
  <done>
    App is wrapped in AuthProvider for auth context access.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add AuthFooter to wizard routes</name>
  <files>
    - src/app/router.tsx
    - src/features/workspace/Workspace.tsx
  </files>
  <action>
    Add AuthFooter to wizard routes (not workspace):

    1. Update src/features/workspace/Workspace.tsx:
    - Remove or comment out any AuthFooter from workspace page
    - Workspace has sign-in/settings button at top right, not footer

    2. Add AuthFooter to wizard routes in router.tsx:
    - /setup/decision
    - /setup/options
    - /criteria
    - /ratings
    - /results

    The AuthFooter should be placed at the bottom of these route elements.

    Example structure for a wizard route:
    - <RequireDecisionSetup>
      - <DraftProvider>
        - <DraftStep />
        - <AuthFooter />
      </DraftProvider>
    </RequireDecisionSetup>

    IMPORTANT: AuthFooter appears in decision pages (wizard routes) as a sticky footer. Workspace has top-right auth button instead.
  </action>
  <verify>
    - AuthFooter is imported
    - AuthFooter appears in wizard routes
    - AuthFooter does NOT appear in workspace route
    - Workspace has sign-in/settings button at top right
  </verify>
  <done>
    AuthFooter appears in wizard routes with sticky footer placement.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add first launch auth choice modal</name>
  <files>
    - src/app/App.tsx
  </files>
  <action>
    Add first launch auth choice modal to App.tsx:

    1. Add state to track if user has seen auth choice modal:
    - useState for showAuthChoiceModal
    - Check localStorage for key: "skip-overthinking:auth-choice-seen:v1"

    2. On app mount (useEffect):
    - If key doesn't exist in localStorage: Show modal (set showAuthChoiceModal = true)
    - If key exists: Don't show modal

    3. Modal component (can reuse SignInModal or create simple dialog):
    - Clear, compact header: "Welcome to Skip Overthinking"
    - Body: "Sign in to save your decisions across devices, or continue locally. Your choice, anytime."
    - Two buttons:
      - "Continue Local" (closes modal, sets localStorage key)
      - "Sign In" (opens sign-in modal, sets localStorage key)

    4. When user makes choice:
    - Set localStorage key: localStorage.setItem("skip-overthinking:auth-choice-seen:v1", "true")
    - Close modal

    IMPORTANT: This is optional per user decision ("auth choice on first app launch"). The modal should be dismissible and not block app usage. Users can still sign in later via footer or workspace.
  </action>
  <verify>
    - App.tsx has first launch auth choice modal logic
    - Modal shows on first launch if localStorage key not set
    - Modal can be dismissed without signing in
    - Modal has "Continue Local" and "Sign In" options
    - localStorage key is set after choice
  </verify>
  <done>
    First launch auth choice modal is implemented.
  </done>
</task>

<task type="auto">
  <name>Task 6: Verify app integration</name>
  <files>
    - src/app/main.tsx
  </files>
  <action>
    Verify src/app/main.tsx is correct:

    1. Ensure createRoot is called correctly
    2. App component is rendered
    3. No additional changes needed (main.tsx should already be correct from Phase 1)

    Run linter and typecheck to verify integration:
    - `bun run lint` (if exists)
    - `bun run typecheck` (if exists)

    If type errors occur, fix them.
  </action>
  <verify>
    - src/app/main.tsx is correct
    - No type errors
    - No lint errors
  </verify>
  <done>
    App integration is verified and type-safe.
  </done>
</task>

</tasks>

<verification>
- App is wrapped in AuthProvider
- Workspace is at root route /
- Wizard routes are preserved
- AuthFooter appears in wizard routes (not workspace)
- First launch modal shows auth choice
- Draft storage still works with localStorage
- No type or lint errors
</verification>

<success_criteria>
- App launches with workspace as default page
- Auth context is available throughout app
- First launch shows auth choice modal
- Users can sign in anytime via footer or workspace
- All requirements SYN-01 and SYN-02 are fully integrated
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-05-SUMMARY.md`
</output>
