---
phase: 05-persistence-auth-and-sync-security
plan: 05
type: execute
wave: 3
depends_on:
  - 05-04
files_modified:
  - src/app/router.tsx
  - src/features/decision/state/draft.storage.ts
autonomous: true
requirements:
  - SYN-01
  - SYN-02
user_setup: []

must_haves:
  truths:
    - "Drafts persist across browser sessions"
    - "Workspace page is at root route /"
    - "Wizard routes work with auth-aware decision management"
  artifacts:
    - path: "src/app/router.tsx"
      provides: "Router with workspace route and wizard routes"
      contains: "createBrowserRouter"
    - path: "src/features/decision/state/draft.storage.ts"
      provides: "Integrated draft storage with auth-aware persistence"
      contains: "hydrateDraft", "persistDraft"
  key_links:
    - from: "src/app/router.tsx"
      to: "src/features/workspace/Workspace.tsx"
      via: "workspace route at /"
      pattern: "path: '/', element: <Workspace"
    - from: "src/features/decision/state/draft.storage.ts"
      to: "src/features/auth/storage/local.storage.ts"
      via: "localStorageService for anonymous mode"
      pattern: "localStorageService"
---

<objective>
Integrate workspace route into app routing and update draft storage.

Purpose: Complete routing integration (SYN-01, SYN-02) with workspace landing and auth-aware draft persistence.
Output: Router with workspace route and updated draft storage that respects auth mode.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/workspace/Workspace.tsx
@src/features/decision/state/draft.storage.ts
@src/features/decision/state/draft.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update draft storage to be auth-aware</name>
  <files>
    - src/features/decision/state/draft.storage.ts
  </files>
  <action>
    Update src/features/decision/state/draft.storage.ts:

    1. Keep existing functions: hydrateDraft, persistDraft, clearDraft

    2. Add auth-aware storage logic:

    Update persistDraft(draft: DecisionDraft): void
    - Check auth state (need to inject auth dependency or check via context hook - for simplicity, add optional auth parameter)
    - If authenticated (user is signed in):
      - Check if draft has an ID (from existing decision or new)
      - If no ID: Generate new ID using generateDecisionId() from local storage utils
      - Create/update decision in Convex: mutation.decisions.create or mutation.decisions.update
      - Do NOT save to localStorage (cache only, handled by storage-sync-service)
    - If not authenticated:
      - Save to localStorage as before
      - Use existing localStorage key: "skip-overthinking:decision-draft:v1"

    Update hydrateDraft(): DecisionDraft | null
    - Check auth state
    - If authenticated:
      - Load from Convex cache (populated by storage-sync-service)
      - Or return null if no draft
    - If not authenticated:
      - Load from localStorage as before

    3. Add new functions:
    - saveDraftToConvex(draft: DecisionDraft, decisionId?: string): Promise<void>
      - Called when authenticated user saves decision
      - Create or update decision in Convex
    - loadDraftFromConvex(decisionId: string): Promise<DecisionDraft | null>
      - Load decision from Convex for editing

    IMPORTANT: For MVP, keep existing localStorage draft storage for simplicity. The main auth integration is at the workspace level (managing completed decisions). Draft editing can remain localStorage for now, with full Convex sync deferred if needed.

    Actually, per the planning context, the single draft pattern should remain. Let me simplify:

    Keep existing localStorage draft storage unchanged. The auth integration is:
    - Anonymous mode: LocalStorage is source of truth for all decisions (draft and completed)
    - Authenticated mode: Convex is source of truth for completed decisions, localStorage is cache only

    For draft editing in authenticated mode, we can either:
    - Keep using localStorage for drafts (simpler for MVP)
    - Move drafts to Convex too (full sync)

    For Phase 5, let's keep drafts in localStorage for simplicity. The key auth integration is:
    - Workspace manages completed decisions
    - Completed decisions sync to Convex when signed in
    - Drafts remain local (can be saved to Convex as "completed" decisions)

    So minimal changes to draft.storage.ts - just keep existing behavior.
  </action>
  <verify>
    - src/features/decision/state/draft.storage.ts functions still work
    - Existing localStorage draft storage is preserved
    - Drafts continue to persist across sessions
  </verify>
  <done>
    Draft storage remains functional with existing localStorage behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update router to include workspace route</name>
  <files>
    - src/app/router.tsx
  </files>
  <action>
    Update src/app/router.tsx:

    1. Import Workspace from "../../features/workspace"

    2. Add workspace route at root:
    - path: "/"
    - element: <Workspace />

    3. Keep existing wizard routes:
    - /setup/decision
    - /setup/options
    - /criteria
    - /ratings
    - /results

    4. Update wizard routes to be under /decision/:id? (optional, for decision-specific routes)
    - For MVP, keep existing routes unchanged
    - When user clicks a decision card in workspace, navigate to /setup/options with draft pre-loaded from that decision

    5. Decision card click handler (in Workspace component) should:
    - Load decision from localStorage or Convex
    - Restore to DraftProvider state
    - Navigate to appropriate route (e.g., /setup/options or /criteria depending on decision completeness)

    IMPORTANT: For MVP simplicity, keep existing wizard routes unchanged. When user clicks a decision card:
    - Load decision data
    - Initialize DraftProvider with that data
    - Navigate to /setup/options (or appropriate step)

    The key change is adding the workspace route at root.
  </action>
  <verify>
    - src/app/router.tsx has workspace route at "/"
    - Existing wizard routes are preserved
    - Workspace route is the default landing page
  </verify>
  <done>
    Router includes workspace route at root with existing wizard routes.
  </done>
</task>

</tasks>

<verification>
- Draft storage still works with localStorage
- Router includes workspace route at root
- Existing wizard routes are preserved
- Workspace is the default landing page
</verification>

<success_criteria>
- App launches with workspace as default page
- Draft storage continues to work
- Wizard routes are accessible
- All requirements SYN-01 and SYN-02 are addressed at the routing level
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-05-SUMMARY.md`
</output>
