---
phase: 05-persistence-auth-and-sync-security
plan: 06
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/features/auth/sync/SyncBanner.tsx
  - src/features/auth/sync/index.ts
  - src/features/auth/auth.context.tsx
  - src/app/App.tsx
  - package.json
autonomous: true
requirements:
  - SYN-02
user_setup: []

must_haves:
  truths:
    - "Sync errors are shown in persistent warning banner at top of app"
    - "Banner persists until sync succeeds"
    - "Banner shows error message and retry option"
    - "Sync status is quiet (no visible status during successful sync)"
    - "User sees warning toast when localStorage is nearly full"
  artifacts:
    - path: "src/features/auth/sync/SyncBanner.tsx"
      provides: "Persistent warning banner for sync errors"
      contains: "SyncBanner"
    - path: "src/features/auth/auth.context.tsx"
      provides: "Auth context with sync error state"
      contains: "syncError"
    - path: "src/app/App.tsx"
      provides: "App with SyncBanner integration"
  key_links:
    - from: "src/features/auth/auth.context.tsx"
      to: "convex/decisions"
      via: "sync error handling from Convex mutations"
      pattern: "try.*mutation\\.catch"
    - from: "src/app/App.tsx"
      to: "src/features/auth/sync/SyncBanner.tsx"
      via: "SyncBanner component in app layout"
      pattern: "<SyncBanner"
    - from: "src/features/auth/auth.context.tsx"
      to: "src/features/auth/sync/SyncBanner.tsx"
      via: "syncError context for banner display"
      pattern: "syncError"
---

<objective>
Add sync status and error handling with persistent warning banner.

Purpose: Handle sync errors gracefully (SYN-02) with persistent banner, quiet successful sync, and offline queue.
Output: Persistent error banner for sync failures, offline queue for reconnection, and quiet successful sync behavior.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/auth/auth.context.tsx
@convex/decisions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync error state to auth context</name>
  <files>
    - src/features/auth/auth.context.tsx
  </files>
  <action>
    Update src/features/auth/auth.context.tsx:

    1. Add to AuthContext interface:
    - syncError: Error | null (current sync error)
    - clearSyncError: () => void (clear sync error state)
    - isSyncing: boolean (sync in progress)
    - setSyncing: (syncing: boolean) => void (set sync state)

    2. Add to AuthProvider:
    - useState for syncError, isSyncing
    - clearSyncError function: setSyncError(null)
    - setSyncing function: setIsSyncing(value)

    3. Wrap Convex mutations with error handling:
    - When calling Convex mutations (decisions.create, decisions.update, etc.)
    - Try the mutation
    - On success: clearSyncError if exists
    - On error: setSyncError(error) to show in banner

    4. Add offline detection (optional for MVP):
    - Use window.addEventListener('online', ...) and 'offline' events
    - Track offline state in context
    - When offline, queue changes (can defer to later implementation)

    For MVP, focus on:
    - Sync error state in context
    - Clear error on success
    - Set error on failure

    IMPORTANT: Convex already handles offline queueing and auto-sync on reconnect. We just need to show errors when sync fails (e.g., network error, server error).
  </action>
  <verify>
    - src/features/auth/auth.context.tsx has syncError state
    - clearSyncError function is defined
    - isSyncing state is defined
    - Convex mutations have try/catch error handling
    - Errors are set to syncError on failure
    - Errors are cleared on success
  </verify>
  <done>
    Auth context manages sync error state with error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sync banner component</name>
  <files>
    - src/features/auth/sync/SyncBanner.tsx
  </files>
  <action>
    Create src/features/auth/sync/SyncBanner.tsx:

    1. Import useAuth from "../auth.context"

    2. Component interface:
    - No props (uses auth context)

    3. Banner content:
    - Persistent warning banner at top of app
    - Background: Yellow/amber warning color
    - Text: Error message from syncError
    - Close button: "Dismiss" or X
    - Retry button: "Retry Sync" (only if authenticated)

    4. Banner behavior:
    - Only show when syncError is not null
    - Persist until user dismisses or sync succeeds
    - Dismiss button: Calls clearSyncError()
    - Retry button: Triggers retry logic (re-sync decisions from cache to Convex)
    - Styling: Fixed at top, full width, clear warning appearance

    5. Retry logic:
    - When retry is clicked, call storage-sync-service cacheFromConvex to re-sync
    - Clear error after retry attempt
    - Show "Retrying..." or similar during retry

    IMPORTANT: Banner is persistent until explicitly dismissed or sync succeeds. Use clear warning styling.
  </action>
  <verify>
    - src/features/auth/sync/SyncBanner.tsx exists
    - Banner shows when syncError is not null
    - Banner has dismiss button
    - Banner has retry button (when authenticated)
    - Banner is fixed at top with warning styling
    - Dismiss calls clearSyncError()
  </verify>
  <done>
    Sync banner shows persistent warning for sync errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate sync banner into app</name>
  <files>
    - src/app/App.tsx
  </files>
  <action>
    Update src/app/App.tsx:

    1. Import SyncBanner from "../features/auth/sync"

    2. Add SyncBanner to app layout:
    - Place at top of app, before RouterProvider
    - Should be fixed at top of viewport
    - Structure: <AuthProvider><SyncBanner /><RouterProvider ... /></AuthProvider>

    3. Styling:
    - Ensure banner doesn't overlap with important content
    - Add padding or margin to account for banner height
    - Or use z-index to ensure banner is above content

    IMPORTANT: Sync banner should be visible above all content when there's a sync error.
  </action>
  <verify>
    - src/app/App.tsx imports SyncBanner
    - SyncBanner is placed above RouterProvider
    - Banner is fixed at top of viewport
    - Content has appropriate spacing for banner
  </verify>
  <done>
    Sync banner is integrated into app layout.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add localStorage quota warning toast</name>
  <files>
    - src/features/workspace/Workspace.tsx
    - src/app/App.tsx
  </files>
  <action>
    Add localStorage quota warning toast:

    1. Choose toast library:
    - If app already has a toast library, use it
    - Otherwise, install sonner: `bun add sonner`
    - Add Toaster component to App.tsx

    2. Add quota check in Workspace component:
    - Use useEffect to periodically check storage quota
    - Call getStorageWarning() from local.storage.ts
    - If warning exists: Show toast with warning message

    3. Warning messages (from storage utils):
    - At 90% full: "Storage is nearly full. Delete older decisions or sign in for cloud storage."
    - At 80% full: "Storage is getting full. Consider deleting older decisions."

    4. Toast behavior:
    - Show warning toast only once per session (or with debounce)
    - Use toast.warning() for warning messages
    - Toast is dismissible

    IMPORTANT: Quota warnings guide users to delete decisions or sign in before hitting hard limit.
  </action>
  <verify>
    - Toast library is installed if needed
    - Toaster component is in App.tsx
    - Workspace checks storage quota on mount
    - Warning toast shows at 80%/90% thresholds
    - Toast shows appropriate message
    - Warning appears only once per session
  </verify>
  <done>
    LocalStorage quota warning toast guides users to free space.
  </done>
</task>

<task type="auto">
  <name>Task 5: Export sync components</name>
  <files>
    - src/features/auth/sync/index.ts
  </files>
  <action>
    Create src/features/auth/sync/index.ts:

    Export sync components:
    - SyncBanner

    This creates a clean public API for consuming sync components.
  </action>
  <verify>
    - src/features/auth/sync/index.ts exists
    - SyncBanner is exported
  </verify>
  <done>
    Sync components are exported and ready for use.
  </done>
</task>

</tasks>

<verification>
- Sync error state is managed in auth context
- Convex mutations have error handling
- Sync banner shows persistent warning when errors occur
- Banner can be dismissed or retried
- Banner is fixed at top of app
- localStorage quota warnings show toast at 80%/90%
- Toast is dismissible
- Sync is quiet (no visible status) during successful sync
</verification>

<success_criteria>
- Sync errors are visible in persistent banner
- User can dismiss or retry sync errors
- Banner persists until success or dismiss
- Quota warnings guide users before hitting limit
- Successful sync is silent/quiet
- Requirement SYN-02 is addressed with sync error handling
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-06-SUMMARY.md`
</output>
