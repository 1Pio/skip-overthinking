---
phase: 05-persistence-auth-and-sync-security
plan: 06
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/features/auth/auth.context.tsx
  - src/features/auth/sync/SyncBanner.tsx
  - src/features/auth/sync/index.ts
autonomous: true
requirements:
  - SYN-02
user_setup: []

must_haves:
  truths:
    - "Sync errors are shown in persistent warning banner at top of app"
    - "Banner persists until sync succeeds"
    - "Banner shows error message and retry option"
    - "Sync status is quiet (no visible status during successful sync)"
  artifacts:
    - path: "src/features/auth/auth.context.tsx"
      provides: "Auth context with sync error state"
      contains: "syncError"
    - path: "src/features/auth/sync/SyncBanner.tsx"
      provides: "Persistent warning banner for sync errors"
      contains: "SyncBanner"
    - path: "src/features/auth/sync/index.ts"
      provides: "Export sync components"
  key_links:
    - from: "src/features/auth/auth.context.tsx"
      to: "convex/decisions"
      via: "sync error handling from Convex mutations"
      pattern: "try.*mutation\\.catch"
    - from: "src/features/auth/auth.context.tsx"
      to: "src/features/auth/sync/SyncBanner.tsx"
      via: "syncError context for banner display"
      pattern: "syncError"
---

<objective>
Add sync error state and persistent warning banner component.

Purpose: Handle sync errors gracefully (SYN-02) with persistent banner and quiet successful sync.
Output: Sync error state in auth context and persistent error banner component.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/auth/auth.context.tsx
@convex/decisions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync error state to auth context</name>
  <files>
    - src/features/auth/auth.context.tsx
  </files>
  <action>
    Update src/features/auth/auth.context.tsx:

    1. Add to AuthContext interface:
    - syncError: Error | null (current sync error)
    - clearSyncError: () => void (clear sync error state)
    - isSyncing: boolean (sync in progress)
    - setSyncing: (syncing: boolean) => void (set sync state)

    2. Add to AuthProvider:
    - useState for syncError, isSyncing
    - clearSyncError function: setSyncError(null)
    - setSyncing function: setIsSyncing(value)

    3. Wrap Convex mutations with error handling:
    - When calling Convex mutations (decisions.create, decisions.update, etc.)
    - Try the mutation
    - On success: clearSyncError if exists
    - On error: setSyncError(error) to show in banner

    4. Add offline detection (optional for MVP):
    - Use window.addEventListener('online', ...) and 'offline' events
    - Track offline state in context
    - When offline, queue changes (can defer to later implementation)

    For MVP, focus on:
    - Sync error state in context
    - Clear error on success
    - Set error on failure

    IMPORTANT: Convex already handles offline queueing and auto-sync on reconnect. We just need to show errors when sync fails (e.g., network error, server error).
  </action>
  <verify>
    - src/features/auth/auth.context.tsx has syncError state
    - clearSyncError function is defined
    - isSyncing state is defined
    - Convex mutations have try/catch error handling
    - Errors are set to syncError on failure
    - Errors are cleared on success
  </verify>
  <done>
    Auth context manages sync error state with error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sync banner component</name>
  <files>
    - src/features/auth/sync/SyncBanner.tsx
  </files>
  <action>
    Create src/features/auth/sync/SyncBanner.tsx:

    1. Import useAuth from "../auth.context"

    2. Component interface:
    - No props (uses auth context)

    3. Banner content:
    - Persistent warning banner at top of app
    - Background: Yellow/amber warning color
    - Text: Error message from syncError
    - Close button: "Dismiss" or X
    - Retry button: "Retry Sync" (only if authenticated)

    4. Banner behavior:
    - Only show when syncError is not null
    - Persist until user dismisses or sync succeeds
    - Dismiss button: Calls clearSyncError()
    - Retry button: Triggers retry logic (re-sync decisions from cache to Convex)
    - Styling: Fixed at top, full width, clear warning appearance

    5. Retry logic:
    - When retry is clicked, call storage-sync-service cacheFromConvex to re-sync
    - Clear error after retry attempt
    - Show "Retrying..." or similar during retry

    IMPORTANT: Banner is persistent until explicitly dismissed or sync succeeds. Use clear warning styling.
  </action>
  <verify>
    - src/features/auth/sync/SyncBanner.tsx exists
    - Banner shows when syncError is not null
    - Banner has dismiss button
    - Banner has retry button (when authenticated)
    - Banner is fixed at top with warning styling
    - Dismiss calls clearSyncError()
  </verify>
  <done>
    Sync banner shows persistent warning for sync errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export sync components</name>
  <files>
    - src/features/auth/sync/index.ts
  </files>
  <action>
    Create src/features/auth/sync/index.ts:

    Export sync components:
    - SyncBanner

    This creates a clean public API for consuming sync components.
  </action>
  <verify>
    - src/features/auth/sync/index.ts exists
    - SyncBanner is exported
  </verify>
  <done>
    Sync components are exported and ready for use.
  </done>
</task>

</tasks>

<verification>
- Sync error state is managed in auth context
- Convex mutations have error handling
- Sync banner shows persistent warning when errors occur
- Banner can be dismissed or retried
- Banner is fixed at top of app
- Sync is quiet (no visible status) during successful sync
</verification>

<success_criteria>
- Sync errors are visible in persistent banner
- User can dismiss or retry sync errors
- Banner persists until success or dismiss
- Successful sync is silent/quiet
- Requirement SYN-02 is addressed with sync error handling
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-06-SUMMARY.md`
</output>
