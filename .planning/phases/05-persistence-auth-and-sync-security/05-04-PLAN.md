---
phase: 05-persistence-auth-and-sync-security
plan: 04
type: execute
wave: 3
depends_on:
  - 05-01
  - 05-02
  - 05-03
files_modified:
  - src/features/workspace/Workspace.tsx
  - src/features/workspace/DecisionCard.tsx
  - src/features/workspace/NewDecisionButton.tsx
  - src/features/workspace/hooks/useMergeOnSignIn.ts
  - src/features/workspace/hooks/useLocalStorageSync.ts
  - src/features/workspace/index.ts
  - src/app/App.tsx
  - src/features/workspace/storage-merge.service.ts
  - src/features/workspace/storage-sync.service.ts
autonomous: false
requirements:
  - SYN-01
  - SYN-02
  - SYN-03
user_setup: []

must_haves:
  truths:
    - "Workspace page displays all decisions as cards (like projects)"
    - "User can create new decision from workspace"
    - "User can view/edit existing decision from workspace"
    - "Sign-in/out button at top right of workspace page"
    - "Signing in merges local decisions into authenticated account"
    - "Toast notification shows merge count: 'X decisions merged'"
    - "Signing out clears local storage and auth tokens"
    - "Merge conflicts are resolved by regenerating local UUID if needed"
  artifacts:
    - path: "src/features/workspace/Workspace.tsx"
      provides: "Main workspace page with decision cards"
      contains: "Workspace"
    - path: "src/features/workspace/DecisionCard.tsx"
      provides: "Decision card component for workspace"
      contains: "DecisionCard"
    - path: "src/features/workspace/NewDecisionButton.tsx"
      provides: "Create new decision button"
      contains: "NewDecisionButton"
    - path: "src/features/workspace/hooks/useMergeOnSignIn.ts"
      provides: "Merge logic for sign-in flow"
      contains: "useMergeOnSignIn"
    - path: "src/features/workspace/storage-merge.service.ts"
      provides: "Merge service for local-to-Convex decisions"
      exports: ["mergeDecisions", "resolveConflict"]
    - path: "src/features/workspace/storage-sync.service.ts"
      provides: "Sync service for Convex localStorage cache"
      exports: ["cacheFromConvex", "clearCache"]
  key_links:
    - from: "src/features/workspace/hooks/useMergeOnSignIn.ts"
      to: "convex/decisions"
      via: "Convex mutations for creating decisions"
      pattern: "mutation\\.create\\(\\)"
    - from: "src/features/workspace/storage-merge.service.ts"
      to: "src/features/auth/storage/local.storage.ts"
      via: "loadDecisions for local decisions"
      pattern: "localStorageService\\.loadDecisions\\(\\)"
    - from: "src/features/workspace/Workspace.tsx"
      to: "src/features/auth/auth.context.tsx"
      via: "useAuth hook for auth state"
      pattern: "useAuth\\(\\)"
    - from: "src/features/workspace/Workspace.tsx"
      to: "convex/decisions"
      via: "useQuery for loading authenticated decisions"
      pattern: "useQuery\\(.*decisions\\.list\\)"
---

<objective>
Build decision workspace page with merge logic and sign-in/sign-out flows.

Purpose: Provide decision organization (workspace), local-to-authenticated merge on sign-in (SYN-01, SYN-02), and complete auth lifecycle.
Output: Workspace page with decision cards, merge logic with conflict resolution, toast notifications, and sign-out handling.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/auth/storage/local.storage.ts
@src/features/auth/auth.context.tsx
@convex/decisions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage merge service</name>
  <files>
    - src/features/workspace/storage-merge.service.ts
  </files>
  <action>
    Create src/features/workspace/storage-merge.service.ts:

    1. Import localStorageService from auth/storage/local.storage.ts

    2. resolveConflict(localDecision: LocalDecision, existingDecision: any): LocalDecision
       - Check if UUIDs conflict (same id)
       - If conflict: Generate new UUID for local decision using generateDecisionId()
       - Update decision.id to new UUID
       - If no conflict: Return local decision unchanged
       - Return resolved decision

    3. mergeDecisions(convex, userId: string): Promise<{ mergedCount: number }>
       - Load local decisions from localStorageService.loadDecisions()
       - If null or empty: Return { mergedCount: 0 }

       - For each local decision:
         - Query Convex to check if decision with same id exists for this user
         - Call convex.mutations.decisions.get({ id: decision.id })
         - If exists (conflict): Call resolveConflict() to regenerate UUID
         - Create decision in Convex: convex.mutations.decisions.create({ ...decision, userId })
         - Increment mergedCount

       - Clear local decisions: localStorageService.clearAll()

       - Return { mergedCount }

    IMPORTANT: Merge preserves decision data by regenerating UUID only when conflicts exist. Server data is never deleted on sign-out.
  </action>
  <verify>
    - src/features/workspace/storage-merge.service.ts exists
    - resolveConflict regenerates UUID on conflict
    - mergeDecisions loads local decisions and creates in Convex
    - mergeDecisions checks for UUID conflicts before creating
    - mergeDecisions clears local storage after merge
    - mergeDecisions returns mergedCount
  </verify>
  <done>
    Storage merge service handles local-to-Convex decision migration with conflict resolution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create storage sync service for authenticated cache</name>
  <files>
    - src/features/workspace/storage-sync.service.ts
  </files>
  <action>
    Create src/features/workspace/storage-sync.service.ts:

    1. Import localStorageService from auth/storage/local.storage.ts

    2. cacheFromConvex(convexDecisions: any[]): void
       - Clear local cache: localStorageService.clearAll()
       - For each Convex decision:
         - Convert to LocalDecision format (Convex already has LocalDecision shape)
         - Save to localStorage: localStorageService.saveDecision(decision)
       - Set lastSyncedAt to current timestamp

    3. clearCache(): void
       - Call localStorageService.clearAll()

    IMPORTANT: When signed in, localStorage is only cache. Convex is source of truth. Cache is kept in sync for offline access.
  </action>
  <verify>
    - src/features/workspace/storage-sync.service.ts exists
    - cacheFromConvex saves Convex decisions to localStorage cache
    - cacheFromConvex clears before writing fresh cache
    - clearCache removes all cached decisions
  </verify>
  <done>
    Storage sync service manages localStorage cache for authenticated users.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useMergeOnSignIn hook</name>
  <files>
    - src/features/workspace/hooks/useMergeOnSignIn.ts
  </files>
  <action>
    Create src/features/workspace/hooks/useMergeOnSignIn.ts:

    1. Import { useEffect } from "react"
    2. Import { useAuth } from "../../auth/auth.context"
    3. Import { useConvex } from "@convex-dev/react"
    4. Import mergeDecisions from "../storage-merge.service"
    5. Import cacheFromConvex from "../storage-sync.service"

    2. useMergeOnSignIn(): void
       - Get auth state from useAuth()
       - Get Convex client from useConvex()

       - useEffect on auth.isAuthenticated and auth.user.id:
         - If isAuthenticated and user.id exists:
           - Call mergeDecisions(convex, user.id)
           - Wait for merge to complete
           - On success: Show toast notification "X decisions merged into your account"
           - On error: Show error toast

    3. For authenticated users (already signed in on load):
       - Use Convex useQuery to load decisions
       - Call cacheFromConvex with loaded decisions on first load

    4. Handle toast notifications (use a toast library like sonner or simple custom implementation):
       - Install toast library if needed: `bun add sonner` (or use existing if app has one)
       - Show toast: toast.success("X decisions merged into your account")

    IMPORTANT: Merge only happens when user signs in (transitions from not authenticated to authenticated). For users already authenticated on load, just cache from Convex.
  </action>
  <verify>
    - src/features/workspace/hooks/useMergeOnSignIn.ts exists
    - useMergeOnSignIn hook is defined
    - Effect triggers on auth.isAuthenticated change
    - Merge is called when user signs in
    - Toast notification shows merge count
    - CacheFromConvex is called for authenticated users on load
  </verify>
  <done>
    useMergeOnSignIn hook handles merge on sign-in and cache for authenticated users.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create decision card component</name>
  <files>
    - src/features/workspace/DecisionCard.tsx
  </files>
  <action>
    Create src/features/workspace/DecisionCard.tsx:

    1. Component interface:
       - decision: LocalDecision (from localStorage or Convex)
       - onClick: (id: string) => void (open decision)
       - onDelete?: (id: string) => void (delete decision - optional for now)

    2. Card content:
       - Title (from decision.title)
       - Description (truncated if long, from decision.description or empty string)
       - Icon (from decision.icon or default icon)
       - Optional metadata:
         - Number of options: decision.options.length
         - Number of criteria: decision.criteria.length
         - Last updated: formatted date from decision.updatedAt

    3. Card styling:
       - Use Tailwind for card layout
       - Hover effect to indicate clickability
       - Clean, minimal design
       - Fixed height or consistent card size for grid layout

    4. Behavior:
       - Click on card: Calls onClick(decision.id)
       - Delete button (if provided): Calls onDelete(decision.id) on separate button

    IMPORTANT: Cards should look like project cards - simple, scanable, with clear title and optional metadata.
  </action>
  <verify>
    - src/features/workspace/DecisionCard.tsx exists
    - Card shows title, description, icon
    - Card shows metadata (options count, criteria count, last updated)
    - Clicking card calls onClick with decision id
    - Styling is clean and minimal with hover effect
  </verify>
  <done>
    Decision card component displays decision summary in workspace.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create new decision button component</name>
  <files>
    - src/features/workspace/NewDecisionButton.tsx
  </files>
  <action>
    Create src/features/workspace/NewDecisionButton.tsx:

    1. Component interface:
       - onClick: () => void (create new decision)

    2. Button content:
       - Icon (plus icon or similar)
       - Text: "New Decision" or "Create Decision"

    3. Button styling:
       - Use Tailwind for button layout
       - Prominent button (primary color)
       - Hover effect

    4. Behavior:
       - Click: Calls onClick() to create new decision and navigate to setup

    IMPORTANT: Button should be prominent to encourage creating new decisions.
  </action>
  <verify>
    - src/features/workspace/NewDecisionButton.tsx exists
    - Button has icon and text
    - Button is prominent with primary styling
    - Clicking calls onClick
  </verify>
  <done>
    New decision button provides clear action to create decisions.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create workspace page component</name>
  <files>
    - src/features/workspace/Workspace.tsx
  </files>
  <action>
    Create src/features/workspace/Workspace.tsx:

    1. Import useAuth from auth/auth.context.tsx
    2. Import useQuery from "@convex-dev/react"
    3. Import useMergeOnSignIn from "./hooks/useMergeOnSignIn"
    4. Import DecisionCard from "./DecisionCard"
    5. Import NewDecisionButton from "./NewDecisionButton"
    6. Import { useNavigate } from "react-router-dom"
    7. Import localStorageService from "../../auth/storage/local.storage.ts"

    2. Component structure:
       - Header:
         - Title: "Decisions" or similar
         - Right side: Sign-in/Settings button (opens settings modal if authenticated, sign-in modal if not)
       - Main content:
         - New decision button
         - Grid of decision cards

    3. Decision loading:
       - If authenticated: Load decisions from Convex: const decisions = useQuery(api.decisions.list)
       - If not authenticated: Load decisions from localStorage: const localDecisions = localStorageService.loadDecisions()
       - Display decisions in grid using DecisionCard component

    4. Call useMergeOnSignIn() to handle merge on sign-in

    5. Navigation:
       - Click on card: navigate to decision (e.g., /decision/{id} or restore to existing wizard flow)
       - Click on new decision: navigate to /setup/decision

    6. Sign-out handling:
       - Settings modal handles sign-out (from plan 03)
       - When sign-out is called: localStorageService.clearAll() (already handled by auth context)

    7. Empty state:
       - If no decisions: Show "No decisions yet. Create your first decision!" message

    IMPORTANT: Workspace is the new landing page where users manage all decisions. Sign-in/out button is at top right (different from footer in decision pages).
  </action>
  <verify>
    - src/features/workspace/Workspace.tsx exists
    - Header has title and sign-in/settings button at top right
    - New decision button is present
    - Decisions are displayed in grid
    - Authenticated users load from Convex, anonymous from localStorage
    - useMergeOnSignIn is called
    - Clicking card navigates to decision
    - Empty state message is shown when no decisions
  </verify>
  <done>
    Workspace page displays all decisions and provides navigation to create/view decisions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Workspace page with decision cards, merge logic on sign-in, and sign-in/sign-out buttons</what-built>
  <how-to-verify>
    1. Start the app: `bun run dev`
    2. Create a decision locally (don't sign in)
    3. Refresh page - verify decision persists
    4. Sign in via footer or workspace sign-in button
    5. Verify toast shows "1 decision merged into your account"
    6. Verify decision appears in workspace
    7. Create another decision while signed in
    8. Sign out via settings modal
    9. Verify local storage is cleared and decisions are gone
    10. Sign back in - verify decisions are still there (server preserved)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 8: Export workspace components</name>
  <files>
    - src/features/workspace/index.ts
  </files>
  <action>
    Create src/features/workspace/index.ts:

    Export all workspace components:
    - Workspace
    - DecisionCard
    - NewDecisionButton

    Also export hooks:
    - useMergeOnSignIn

    This creates a clean public API for consuming workspace components.
  </action>
  <verify>
    - src/features/workspace/index.ts exists
    - Workspace is exported
    - DecisionCard is exported
    - NewDecisionButton is exported
    - useMergeOnSignIn is exported
  </verify>
  <done>
    Workspace components are exported and ready for use.
  </done>
</task>

</tasks>

<verification>
- Workspace page displays decisions as cards in a grid
- New decision button creates new decisions
- Signing in merges local decisions with toast notification
- Merge conflicts are resolved by regenerating UUID
- Signing out clears local storage
- Sign-in/sign-out buttons at top right of workspace
- Authenticated users load from Convex, anonymous from localStorage
- Empty state shows when no decisions
</verification>

<success_criteria>
- Workspace page is the new landing page
- Decisions are displayed as project-like cards
- Sign-in merges local decisions with notification
- Sign-out clears local cache
- All requirements SYN-01, SYN-02, SYN-03 are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-04-SUMMARY.md`
</output>
