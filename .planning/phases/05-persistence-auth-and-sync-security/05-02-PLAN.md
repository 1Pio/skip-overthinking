---
phase: 05-persistence-auth-and-sync-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/storage/local.storage.ts
  - src/features/auth/storage/local.types.ts
  - src/features/auth/storage/utils.ts
  - package.json
  - src/features/auth/storage/index.ts
autonomous: true
requirements:
  - SYN-01
  - SYN-04
user_setup: []

must_haves:
  truths:
    - "Decisions can be saved to localStorage when user is not authenticated"
    - "Decisions can be loaded from localStorage across browser sessions"
    - "Anonymous decisions are never sent to Convex server"
    - "LocalStorage quota warnings are shown when approaching 5MB limit"
    - "Decisions can be deleted from localStorage"
  artifacts:
    - path: "src/features/auth/storage/local.types.ts"
      provides: "LocalStorage decision storage types"
      exports: ["LocalDecisions", "LocalDecision"]
    - path: "src/features/auth/storage/local.storage.ts"
      provides: "LocalStorage CRUD operations for decisions"
      exports: ["saveDecision", "loadDecisions", "loadDecision", "deleteDecision", "clearAll"]
    - path: "src/features/auth/storage/utils.ts"
      provides: "LocalStorage quota checking and key management"
      exports: ["checkQuota", "getStorageUsed", "generateDecisionId"]
    - path: "src/features/auth/storage/index.ts"
      provides: "Public API for local storage operations"
      exports: ["localStorageService"]
  key_links:
    - from: "src/features/auth/storage/local.storage.ts"
      to: "src/features/auth/storage/local.types.ts"
      via: "type annotations"
      pattern: "LocalDecision"
    - from: "src/features/auth/storage/local.storage.ts"
      to: "localStorage"
      via: "window.localStorage API"
      pattern: "localStorage\\.(getItem|setItem|removeItem)"
    - from: "src/features/auth/storage/utils.ts"
      to: "localStorage"
      via: "quota calculation"
      pattern: "JSON\\.stringify\\(.*\\)\\.length"
---

<objective>
Implement localStorage-based decision storage for anonymous users (local-only mode).

Purpose: Enable local persistence without login (SYN-01) while ensuring anonymous decisions never touch the server (SYN-04).
Output: LocalStorage service for decisions with CRUD operations, quota management, and UUID generation.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/decision/state/draft.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define LocalStorage types and decision model</name>
  <files>
    - src/features/auth/storage/local.types.ts
  </files>
  <action>
    Create src/features/auth/storage/local.types.ts:

    1. Import DecisionDraft from src/features/decision/state/draft.types.ts

    2. Define LocalDecision interface extending DecisionDraft with:
       - id: string (UUID - decision identifier, separate from draft's internal state)
       - createdAt: number (timestamp)
       - updatedAt: number (timestamp)

    3. Define LocalDecisions interface:
       - decisions: Record<string, LocalDecision> (key = id)
       - lastSyncedAt: number | null (null for anonymous mode)

    4. Define LocalStorageKeys constant:
       - DECISIONS = "skip-overthinking:decisions:v1" (stores all local decisions)
       - CURRENT_DRAFT_ID = "skip-overthinking:current-draft-id:v1" (tracks which draft is active)

    5. Define StorageError type:
       - QUOTA_EXCEEDED = "QUOTA_EXCEEDED"
       - NOT_FOUND = "NOT_FOUND"
       - PARSE_ERROR = "PARSE_ERROR"

    IMPORTANT: LocalDecision.id is the decision UUID for workspace management. The existing DecisionDraft is the active decision state being edited. They are separate concepts.
  </action>
  <verify>
    - src/features/auth/storage/local.types.ts exists
    - LocalDecision extends DecisionDraft with id/createdAt/updatedAt
    - LocalDecisions has decisions record and lastSyncedAt
    - LocalStorageKeys constant is defined
    - StorageError type exists with QUOTA_EXCLUDED/NOT_FOUND/PARSE_ERROR
  </verify>
  <done>
    LocalStorage types are defined with decision model extending DecisionDraft.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement localStorage CRUD operations</name>
  <files>
    - src/features/auth/storage/local.storage.ts
  </files>
  <action>
    Create src/features/auth/storage/local.storage.ts:

    1. Import types from local.types.ts

    2. loadDecisions(): LocalDecisions | null
       - Get from localStorage using DECISIONS key
       - Parse JSON, return null if not found or parse error
       - Handle parse error by returning null

    3. loadDecision(id: string): LocalDecision | null
       - Call loadDecisions()
       - Return decision with matching id or null

    4. saveDecision(decision: LocalDecision): void
       - Call loadDecisions() to get existing
       - Update decisions record with decision
       - Call checkQuota() from utils before saving (throws if quota exceeded)
       - Update decision.updatedAt to Date.now()
       - Set item in localStorage

    5. deleteDecision(id: string): boolean
       - Call loadDecisions() to get existing
       - Delete id from decisions record
       - Save updated record to localStorage
       - Return true if deleted, false if not found

    6. clearAll(): void
       - Remove DECISIONS key from localStorage
       - Remove CURRENT_DRAFT_ID key from localStorage

    7. setCurrentDraftId(id: string | null): void
       - Set CURRENT_DRAFT_ID key to id or remove if null

    8. getCurrentDraftId(): string | null
       - Get CURRENT_DRAFT_ID key, return null if not found

    All CRUD operations MUST use try/catch for localStorage errors and handle QUOTA_EXCEEDED errors by re-throwing.
  </action>
  <verify>
    - src/features/auth/storage/local.storage.ts exists
    - loadDecisions/getDecision/saveDecision/deleteDecision/clearAll functions exist
    - setCurrentDraftId/getCurrentDraftId functions exist
    - All functions use try/catch for error handling
    - saveDecision calls checkQuota before writing
  </verify>
  <done>
    LocalStorage CRUD operations are implemented for decision persistence.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement utility functions for quota and UUID</name>
  <files>
    - src/features/auth/storage/utils.ts
  </files>
  <action>
    Create src/features/auth/storage/utils.ts:

    1. generateDecisionId(): string
       - Generate UUID using crypto.randomUUID() or fallback to a simple random implementation
       - Return UUID string

    2. getStorageUsed(): number
       - Iterate through all localStorage keys
       - Calculate total bytes used (UTF-16 string length * 2)
       - Return bytes used

    3. checkQuota(additionalBytes: number = 0): { safe: boolean; used: number; limit: number; remaining: number }
       - Calculate limit: 5 * 1024 * 1024 (5MB)
       - Call getStorageUsed() to get current usage
       - Add additionalBytes to current usage
       - Calculate remaining: limit - (used + additionalBytes)
       - If remaining < 0: safe: false (would exceed quota)
       - Else: safe: true

    4. getStorageWarning(): { showWarning: boolean; message: string } | null
       - Call checkQuota() with 0 additional bytes
       - If used > limit * 0.9 (90% full):
         - showWarning: true
         - message: "Storage is nearly full. Delete older decisions or sign in for cloud storage."
       - Else if used > limit * 0.8 (80% full):
         - showWarning: true
         - message: "Storage is getting full. Consider deleting older decisions."
       - Else: null

    5. formatBytes(bytes: number): string
       - Convert bytes to human-readable format (KB, MB)
       - Return formatted string with 1 decimal place

    IMPORTANT: The 5MB limit is a typical localStorage limit. The warning thresholds (80%, 90%) give users time to act.
  </action>
  <verify>
    - src/features/auth/storage/utils.ts exists
    - generateDecisionId creates unique identifiers
    - getStorageUsed calculates total localStorage bytes
    - checkQuota returns safe flag with usage details
    - getStorageWarning returns warning at 80%/90% thresholds
    - formatBytes converts bytes to readable format
  </verify>
  <done>
    Utility functions for quota checking and UUID generation are implemented.
  </done>
</task>

<task type="auto">
  <name>Task 4: Export localStorage service API</name>
  <files>
    - src/features/auth/storage/index.ts
  </files>
  <action>
    Create src/features/auth/storage/index.ts:

    Export localStorageService object with all CRUD and utility functions:
    - loadDecisions
    - loadDecision
    - saveDecision
    - deleteDecision
    - clearAll
    - setCurrentDraftId
    - getCurrentDraftId
    - generateDecisionId
    - checkQuota
    - getStorageWarning
    - formatBytes

    Also export types:
    - LocalDecision
    - LocalDecisions
    - StorageError
    - LocalStorageKeys

    This creates a clean public API for other modules to use.
  </action>
  <verify>
    - src/features/auth/storage/index.ts exists
    - localStorageService object exports all functions
    - Types are exported from index
    - API is consistent with function implementations
  </verify>
  <done>
    LocalStorage service API is exported and ready for consumption.
  </done>
</task>

</tasks>

<verification>
- LocalStorage types define LocalDecision extending DecisionDraft with UUID and timestamps
- CRUD operations save/load/delete decisions from localStorage
- Quota checking warns at 80%/90% of 5MB limit
- UUID generation creates unique decision IDs
- Anonymous decisions only interact with localStorage, never Convex
</verification>

<success_criteria>
- LocalStorage service provides complete CRUD for decisions
- Decisions persist across browser sessions
- Quota warnings guide users before hitting storage limit
- All requirements SYN-01 and SYN-04 are addressed at the local storage level
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-02-SUMMARY.md`
</output>
