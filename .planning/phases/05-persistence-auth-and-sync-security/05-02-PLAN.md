---
phase: 05-persistence-auth-and-sync-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/storage/local.types.ts
  - src/features/auth/storage/local.storage.ts
  - src/features/auth/storage/index.ts
autonomous: true
requirements:
  - SYN-01
  - SYN-04
user_setup: []

must_haves:
  truths:
    - "Decisions can be saved to localStorage when user is not authenticated"
    - "Decisions can be loaded from localStorage across browser sessions"
    - "User's anonymous decisions remain local-only"
    - "Decisions can be deleted from localStorage"
  artifacts:
    - path: "src/features/auth/storage/local.types.ts"
      provides: "LocalStorage decision storage types"
      exports: ["LocalDecisions", "LocalDecision"]
    - path: "src/features/auth/storage/local.storage.ts"
      provides: "LocalStorage CRUD operations for decisions"
      exports: ["saveDecision", "loadDecisions", "loadDecision", "deleteDecision", "clearAll"]
    - path: "src/features/auth/storage/index.ts"
      provides: "Public API for local storage operations"
      exports: ["localStorageService"]
  key_links:
    - from: "src/features/auth/storage/local.storage.ts"
      to: "src/features/auth/storage/local.types.ts"
      via: "type annotations"
      pattern: "LocalDecision"
    - from: "src/features/auth/storage/local.storage.ts"
      to: "localStorage"
      via: "window.localStorage API"
      pattern: "localStorage\\.(getItem|setItem|removeItem)"
---

<objective>
Define localStorage types and implement CRUD operations for anonymous decision storage.

Purpose: Enable local persistence without login (SYN-01) while ensuring anonymous decisions never touch the server (SYN-04).
Output: LocalStorage types, CRUD operations for decisions, and public API.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/decision/state/draft.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define LocalStorage types and decision model</name>
  <files>
    - src/features/auth/storage/local.types.ts
  </files>
  <action>
    Create src/features/auth/storage/local.types.ts:

    1. Import DecisionDraft from src/features/decision/state/draft.types.ts

    2. Define LocalDecision interface extending DecisionDraft with:
       - id: string (UUID - decision identifier, separate from draft's internal state)
       - createdAt: number (timestamp)
       - updatedAt: number (timestamp)

    3. Define LocalDecisions interface:
       - decisions: Record<string, LocalDecision> (key = id)
       - lastSyncedAt: number | null (null for anonymous mode)

    4. Define LocalStorageKeys constant:
       - DECISIONS = "skip-overthinking:decisions:v1" (stores all local decisions)
       - CURRENT_DRAFT_ID = "skip-overthinking:current-draft-id:v1" (tracks which draft is active)

    5. Define StorageError type:
       - QUOTA_EXCEEDED = "QUOTA_EXCEEDED"
       - NOT_FOUND = "NOT_FOUND"
       - PARSE_ERROR = "PARSE_ERROR"

    IMPORTANT: LocalDecision.id is the decision UUID for workspace management. The existing DecisionDraft is the active decision state being edited. They are separate concepts.
  </action>
  <verify>
    - src/features/auth/storage/local.types.ts exists
    - LocalDecision extends DecisionDraft with id/createdAt/updatedAt
    - LocalDecisions has decisions record and lastSyncedAt
    - LocalStorageKeys constant is defined
    - StorageError type exists with QUOTA_EXCEEDED/NOT_FOUND/PARSE_ERROR
  </verify>
  <done>
    LocalStorage types are defined with decision model extending DecisionDraft.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement localStorage CRUD operations</name>
  <files>
    - src/features/auth/storage/local.storage.ts
  </files>
  <action>
    Create src/features/auth/storage/local.storage.ts:

    1. Import types from local.types.ts

    2. loadDecisions(): LocalDecisions | null
       - Get from localStorage using DECISIONS key
       - Parse JSON, return null if not found or parse error
       - Handle parse error by returning null

    3. loadDecision(id: string): LocalDecision | null
       - Call loadDecisions()
       - Return decision with matching id or null

    4. saveDecision(decision: LocalDecision): void
       - Call loadDecisions() to get existing
       - Update decisions record with decision
       - Call checkQuota() from utils before saving (throws if quota exceeded)
       - Update decision.updatedAt to Date.now()
       - Set item in localStorage

    5. deleteDecision(id: string): boolean
       - Call loadDecisions() to get existing
       - Delete id from decisions record
       - Save updated record to localStorage
       - Return true if deleted, false if not found

    6. clearAll(): void
       - Remove DECISIONS key from localStorage
       - Remove CURRENT_DRAFT_ID key from localStorage

    7. setCurrentDraftId(id: string | null): void
       - Set CURRENT_DRAFT_ID key to id or remove if null

    8. getCurrentDraftId(): string | null
       - Get CURRENT_DRAFT_ID key, return null if not found

    All CRUD operations MUST use try/catch for localStorage errors and handle QUOTA_EXCEEDED errors by re-throwing.
  </action>
  <verify>
    - src/features/auth/storage/local.storage.ts exists
    - loadDecisions/getDecision/saveDecision/deleteDecision/clearAll functions exist
    - setCurrentDraftId/getCurrentDraftId functions exist
    - All functions use try/catch for error handling
    - saveDecision calls checkQuota before writing
  </verify>
  <done>
    LocalStorage CRUD operations are implemented for decision persistence.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export localStorage service API</name>
  <files>
    - src/features/auth/storage/index.ts
  </files>
  <action>
    Create src/features/auth/storage/index.ts:

    Export localStorageService object with all CRUD and utility functions:
    - loadDecisions
    - loadDecision
    - saveDecision
    - deleteDecision
    - clearAll
    - setCurrentDraftId
    - getCurrentDraftId

    Also export types:
    - LocalDecision
    - LocalDecisions
    - StorageError
    - LocalStorageKeys

    This creates a clean public API for other modules to use.
  </action>
  <verify>
    - src/features/auth/storage/index.ts exists
    - localStorageService object exports all functions
    - Types are exported from index
    - API is consistent with function implementations
  </verify>
  <done>
    LocalStorage service API is exported and ready for consumption.
  </done>
</task>

</tasks>

<verification>
- LocalStorage types define LocalDecision extending DecisionDraft with UUID and timestamps
- CRUD operations save/load/delete decisions from localStorage
- Anonymous decisions only interact with localStorage, never Convex
</verification>

<success_criteria>
- LocalStorage service provides complete CRUD for decisions
- Decisions persist across browser sessions
- All requirements SYN-01 and SYN-04 are addressed at the local storage level
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-02-SUMMARY.md`
</output>
