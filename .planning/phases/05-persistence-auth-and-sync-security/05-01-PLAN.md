---
phase: 05-persistence-auth-and-sync-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/auth.config.ts
  - convex/decisions.ts
  - convex/_generated.ts
  - package.json
  - convex/auth.ts
autonomous: true
requirements:
  - SYN-02
  - SYN-03
user_setup:
  - service: convex
    why: "Backend auth and data sync"
    env_vars:
      - name: CONVEX_DEPLOYMENT
        source: "Convex Dashboard -> Settings"
      - name: CONVEX_DEPLOY_KEY
        source: "Convex Dashboard -> Settings -> Deployment Keys"
    dashboard_config:
      - task: "Create Convex project and configure auth providers"
        location: "Convex Dashboard -> Auth"
      - task: "Set data location to Europe"
        location: "Convex Dashboard -> Settings -> Deployment location"

must_haves:
  truths:
    - "Users can only access their own decisions"
    - "Authentication prevents unauthorized data access"
    - "User can sign in with Email, Google, or GitHub"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Convex schema with decisions table and userId ownership"
      contains: "defineTable"
    - path: "convex/auth.config.ts"
      provides: "Convex auth configuration for Email/Google/GitHub"
      contains: "auth"
    - path: "convex/decisions.ts"
      provides: "Backend functions with userId ownership enforcement"
      exports: ["create", "update", "list", "get", "delete"]
    - path: "convex/_generated.ts"
      provides: "Generated Convex types for frontend usage"
  key_links:
    - from: "convex/decisions.ts"
      to: "convex/schema.ts"
      via: "type inference from schema definition"
      pattern: "ctx\\.auth\\.userId"
    - from: "convex/auth.config.ts"
      to: "Convex auth providers"
      via: "configuration objects"
      pattern: "providers"
---

<objective>
Setup Convex backend foundation with auth and ownership-enforced decision storage.

Purpose: Provide authenticated sync foundation (SYN-02) with backend ownership enforcement (SYN-03).
Output: Configured Convex project with auth providers, decisions schema with userId ownership, and secure backend functions.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Convex and configure auth providers</name>
  <files>
    - convex/auth.config.ts
    - convex/auth.ts
    - package.json
  </files>
  <action>
    1. Install Convex: `bun add convex`
    2. Initialize Convex: `npx convex dev` (creates convex/ directory and config)
    3. Create convex/auth.config.ts with auth providers:
       - Email: allow any domain
       - Google: enabled (requires client setup in Convex dashboard)
       - GitHub: enabled (requires client setup in Convex dashboard)
    4. Create convex/auth.ts as module export for auth utilities
    5. Add Convex dev and deployment scripts to package.json:
       - "dev:convex": "convex dev"
       - "deploy:convex": "convex deploy"

    IMPORTANT: Do NOT run `npx convex dev` or `convex dev` in this task. Just install dependencies and create files. The user will need to set up the Convex project, providers, and Europe data location manually via the dashboard before running dev.
  </action>
  <verify>
    - package.json contains "convex" in dependencies
    - convex/auth.config.ts exists with Email/Google/GitHub providers configured
    - convex/auth.ts exists as module
    - package.json contains dev:convex and deploy:convex scripts
  </verify>
  <done>
    Convex is installed, auth providers are configured, and scripts are ready for deployment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define decisions schema with userId ownership</name>
  <files>
    - convex/schema.ts
    - convex/_generated.ts
  </files>
  <action>
    Create convex/schema.ts with:
    1. Define decisions table with fields:
       - id (string, indexed)
       - userId (string, indexed - from auth token)
       - title (string)
       - description (string, optional)
       - icon (string, optional)
       - options (v.array(v.object({...})) - mirror DecisionDraft.options shape)
       - criteria (v.array(v.object({...})) - mirror DecisionDraft.criteria shape)
       - ratings (v.record(v.string(), v.number())) - mirror DecisionDraft.ratings shape
       - weights (v.record(v.string(), v.number())) - mirror DecisionDraft.weights shape)
       - createdAt (v.number())
       - updatedAt (v.number())
    2. Add indexes:
       - by_userId (on userId) for listing user's decisions
       - by_userId_and_id (on userId, id) for ownership-enforced access
    3. Generate types: `npx convex dev --once --skip-convex-deploy` or instruct user to run `npx convex dev`

    IMPORTANT: The DecisionDraft type should be mirrored from src/features/decision/state/draft.types.ts. Use the exact same structure for options, criteria, ratings, weights to ensure compatibility.

    DO NOT run convex dev command here - just create the schema file. The types will be generated when the user sets up their Convex project.
  </action>
  <verify>
    - convex/schema.ts exists with decisions table definition
    - schema includes userId field with index
    - schema includes by_userId and by_userId_and_id indexes
    - options/criteria/ratings/weights fields mirror DecisionDraft structure
  </verify>
  <done>
    Convex schema is defined with ownership-enforced decision storage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement backend functions with ownership checks</name>
  <files>
    - convex/decisions.ts
  </files>
  <action>
    Create convex/decisions.ts with authenticated functions:

    1. create(ctx, args):
       - Check ctx.auth.userId (throw if not authenticated)
       - Generate decision ID or use provided args.id
       - Insert with userId, data, createdAt/updatedAt timestamps
       - Return created decision
       - Ownership: userId must equal ctx.auth.userId

    2. update(ctx, args):
       - Check ctx.auth.userId
       - Query by id using by_userId_and_id index with userId filter
       - Update fields, increment updatedAt
       - Return updated decision
       - Ownership: enforced by index query (only returns if userId matches)

    3. list(ctx):
       - Check ctx.auth.userId
       - Query by_userId index
       - Return all user's decisions
       - Ownership: enforced by index

    4. get(ctx, args):
       - Check ctx.auth.userId
       - Query by_userId_and_id index with userId and id
       - Return decision or null
       - Ownership: enforced by index query

    5. delete(ctx, args):
       - Check ctx.auth.userId
       - Query by_userId_and_id index with userId and id
       - Delete document
       - Return success
       - Ownership: enforced by index query

    All functions MUST use v.object schema validation for args.

    IMPORTANT: These functions are for authenticated sync only (SYN-02, SYN-03). Anonymous decisions are handled via localStorage (SYN-01, SYN-04).
  </action>
  <verify>
    - convex/decisions.ts exists with create/update/list/get/delete functions
    - All functions check ctx.auth.userId
    - create inserts with userId
    - update/get/delete query by by_userId_and_id index
    - list queries by by_userId index
    - All functions use v.object schema validation
  </verify>
  <done>
    Backend functions enforce userId ownership on all authenticated operations.
  </done>
</task>

</tasks>

<verification>
- Convex dependencies are installed
- Auth providers are configured for Email, Google, and GitHub
- Decisions schema exists with userId field and ownership indexes
- Backend functions enforce userId ownership checks
- Schema mirrors DecisionDraft structure for options/criteria/ratings/weights
</verification>

<success_criteria>
- User can run `bun add convex` successfully
- convex/auth.config.ts is ready for user to deploy to their Convex project
- convex/schema.ts defines decisions table with userId ownership
- convex/decisions.ts provides secure backend operations with ownership enforcement
- All requirements SYN-02 and SYN-03 are addressed at the backend level
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-auth-and-sync-security/05-01-SUMMARY.md`
</output>
