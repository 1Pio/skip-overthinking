---
phase: 02-typed-criteria-modeling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/criteria/criteria.schema.ts
  - src/features/criteria/criteriaGate.schema.ts
  - src/features/criteria/state/criterion.types.ts
  - src/features/criteria/state/criterion.actions.ts
  - src/features/criteria/state/criterionPrereq.ts
  - src/features/criteria/templates.ts
  - src/features/decision/state/draft.types.ts
  - src/features/decision/state/draft.reducer.ts
autonomous: true
must_haves:
  truths:
    - "Criteria are stored as typed entries limited to rating_1_20 and numeric_measured."
    - "Numeric measured criteria require a raw direction selection and optionally include a unit."
    - "Users cannot continue to ratings until at least one valid criterion is configured."
  artifacts:
    - path: "src/features/criteria/criteria.schema.ts"
      provides: "Single discriminated-union criterion contract with 1-20 desirability semantics"
      contains: "z.discriminatedUnion"
    - path: "src/features/criteria/state/criterion.actions.ts"
      provides: "Pure criteria add/edit/delete/reorder/multi-delete actions"
      contains: "criterionAdded"
    - path: "src/features/decision/state/draft.types.ts"
      provides: "DecisionDraft includes canonical criteria array"
      contains: "criteria"
  key_links:
    - from: "src/features/criteria/state/criterionPrereq.ts"
      to: "src/features/criteria/criteriaGate.schema.ts"
      via: "safeParse"
      pattern: "criteriaGateSchema\.safeParse"
    - from: "src/features/decision/state/draft.reducer.ts"
      to: "src/features/criteria/state/criterion.actions.ts"
      via: "criteria action union handling"
      pattern: "criterion"
---

<objective>
Create the canonical typed criteria domain contract and reducer wiring so all Phase 2 interactions share one source of truth before UI composition starts.

Purpose: Prevent schema drift across templates, CRUD, and route guards while honoring locked semantics (two types only, no invert toggle, 1-20 desirability invariant).
Output: Criteria schema/gate files, typed action helpers, template catalog defaults, and DecisionDraft reducer integration for criteria state.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-typed-criteria-modeling/02-CONTEXT.md
@.planning/phases/02-typed-criteria-modeling/02-RESEARCH.md
@.planning/phases/01-foundation-setup-and-options/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define canonical criteria schema, gate, and template defaults</name>
  <files>src/features/criteria/criteria.schema.ts, src/features/criteria/criteriaGate.schema.ts, src/features/criteria/state/criterion.types.ts, src/features/criteria/templates.ts</files>
  <action>Create a single Zod discriminated-union schema keyed by `type` with only `rating_1_20` and `numeric_measured` variants (explicitly exclude boolean/enum per locked decision). Enforce required trimmed criterion title, optional trimmed description, stable id/order fields, and desirability invariant language (1-20 higher-is-better, never 0). For `numeric_measured`, require `rawDirection` enum (`lower_raw_better` | `higher_raw_better`) and keep `unit` optional/contextual. Add a `criteriaGateSchema` requiring at least one valid criterion and export typed aliases used by route/UI checks. Add v1 template catalog (6-8 templates) split into `Recommended` and `Measured` groups with one-line purpose copy and strong defaults (title/type/rawDirection guidance where relevant) as typed draft factories, not a separate data model.</action>
  <verify>`bun run build && bun run lint` succeeds; schema file exposes both variants only; template catalog exports 6-8 entries split across recommended/measured.</verify>
  <done>Criteria contract is canonical and typed, gate schema exists for shared completion checks, and template defaults are ready for confirm/customize flow without introducing out-of-scope criterion types.</done>
</task>

<task type="auto">
  <name>Task 2: Add criteria action creators and integrate criteria into draft reducer state</name>
  <files>src/features/criteria/state/criterion.actions.ts, src/features/criteria/state/criterionPrereq.ts, src/features/decision/state/draft.types.ts, src/features/decision/state/draft.reducer.ts</files>
  <action>Implement pure criteria action creators mirroring existing options patterns: add, edit, delete, reorder (up/down only for this phase), enter/clear selection mode payloads, and multi-delete with undo payload support. Ensure actions emit fully normalized criteria arrays (dense `order`) with immutable updates and no `any`/type assertions. Extend `DecisionDraft` to include `criteria` and initialize empty criteria in default draft. Extend reducer union handling so criteria transitions are reducer-owned canonical state. Add `hasMinimumCriteria`/`isCriteriaStepComplete` helper(s) delegating to `criteriaGateSchema.safeParse` so route guards and continue controls share one source of truth.</action>
  <verify>`bun run build && bun run lint` succeeds; reducer handles criteria actions without exhaustiveness/type errors; criterion prereq helpers compile and return booleans from gate parsing.</verify>
  <done>Criteria state is persisted and reducer-backed, action creators provide deterministic criteria transitions, and prerequisite helper(s) exist for route and UI gate reuse.</done>
</task>

</tasks>

<verification>
Run `bun run build && bun run lint`, then inspect `DecisionDraft` type and reducer to confirm criteria state/actions are wired through the same canonical state path used by existing setup/options steps.
</verification>

<success_criteria>
Phase 2 foundation is ready when criteria can be represented, validated, mutated, and gated entirely through typed schema + reducer primitives with no boolean/enum types and no invert-toggle fields present.
</success_criteria>

<output>
After completion, create `.planning/phases/02-typed-criteria-modeling/02-01-SUMMARY.md`
</output>
