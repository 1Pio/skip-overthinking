---
phase: 02-typed-criteria-modeling
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/criteria/state/criterion.actions.ts
autonomous: false
gap_closure: true
must_haves:
  truths:
    - "User can reorder criteria with Move up and Move down controls, and list order visibly updates after each move."
    - "Move controls remain bounded (top item cannot move up, bottom item cannot move down) while non-boundary moves still change order."
    - "Criteria order remains dense and deterministic (0..n-1) after reorder so downstream list rendering and persistence stay stable."
  artifacts:
    - path: "src/features/criteria/state/criterion.actions.ts"
      provides: "Reorder-safe criteria normalization that preserves post-splice sequence"
      contains: "criterionReordered"
  key_links:
    - from: "src/features/criteria/components/CriteriaStep.tsx"
      to: "src/features/criteria/state/criterion.actions.ts"
      via: "criterionReordered dispatch"
      pattern: "criterionReordered"
    - from: "src/features/criteria/state/criterion.actions.ts"
      to: "src/features/criteria/components/CriteriaList.tsx"
      via: "updated criteria order consumed for rendered row order"
      pattern: "criteria:"
---

<objective>
Close the diagnosed reorder regression so Criteria Move up/down controls actually change list order in the Phase 2 criteria authoring flow.

Purpose: Restore CRT-01 reorder behavior and unblock the only failed UAT gap for Phase 2 without introducing scope creep.
Output: Fixed reorder action logic plus human-confirmed UAT rerun for criteria up/down controls.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-typed-criteria-modeling/02-CONTEXT.md
@.planning/phases/02-typed-criteria-modeling/02-UAT.md
@.planning/debug/criteria-reorder-up-down-not-working.md
@.planning/phases/02-typed-criteria-modeling/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix criterion reorder normalization to preserve moved sequence</name>
  <files>src/features/criteria/state/criterion.actions.ts</files>
  <action>Update reorder normalization so `criterionReordered` preserves the post-splice array sequence instead of re-sorting by stale `order` values. Keep canonical dense ordering after reorder by applying a reindex-only pass (no sort) on the already-moved array. Retain existing `up`/`down` boundaries and no-op behavior when source or target is unchanged. Do not alter criteria type semantics, delete/undo semantics, or template/editor flows.</action>
  <verify>`bun run build && bun run lint` succeeds.</verify>
  <done>Dispatching `criterionReordered` with a movable criterion changes relative list position and still returns criteria with dense `order` values starting at 0.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Re-run UAT Test 5 for criteria move controls</name>
  <action>Perform targeted runtime validation for the diagnosed reorder gap using the exact UAT interaction path, then report pass/fail with observed behavior.</action>
  <what-built>Reorder action no longer cancels itself during normalization, so Move up/down should now update rendered order.</what-built>
  <how-to-verify>
    1) Run `bun run dev` and open `/criteria`.
    2) Ensure at least three criteria exist in the list.
    3) Click `Move up` on a middle criterion; expected: it moves one row higher immediately.
    4) Click `Move down` on a middle criterion; expected: it moves one row lower immediately.
    5) Confirm boundary controls still disable correctly for first/last rows.
  </how-to-verify>
  <verify>UAT Test 5 passes when both move directions visibly reorder rows and only boundary rows remain disabled.</verify>
  <done>Human verification confirms reorder controls are functional and the diagnosed regression is no longer reproducible.</done>
  <resume-signal>Type "approved" if reorder now works, or report exact failing interaction.</resume-signal>
</task>

</tasks>

<verification>
Run `bun run build && bun run lint`, then complete the blocking reorder interaction check in `/criteria` to confirm UAT Test 5 passes.
</verification>

<success_criteria>
Phase 2 gap is closed when Move up/down reorders criteria reliably, boundary disable behavior remains correct, and UAT test 5 is approved by human verification.
</success_criteria>

<output>
After completion, create `.planning/phases/02-typed-criteria-modeling/02-05-SUMMARY.md`
</output>
