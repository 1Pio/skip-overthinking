---
phase: 03-ratings-weights-and-coverage-integrity
plan: 03
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - src/features/ratings/components/RatingsStep.tsx
  - src/features/ratings/components/WeightsCoveragePanel.tsx
  - src/features/ratings/state/rating.selectors.ts
  - src/features/ratings/state/ratingPrereq.ts
  - src/routes/ratings/RatingsRoute.tsx
  - src/routes/results/ResultsRoute.tsx
autonomous: true
must_haves:
  truths:
    - "User can assign integer weights for every criterion directly in ratings workflow."
    - "User is blocked from results until all criterion weights are assigned."
    - "User sees per-option weighted coverage with inline severity bands (<70% warning, <50% strong warning)."
    - "User sees softer criterion-level blank-rate warnings in expandable detail without interrupting default flow."
    - "Coverage/warning status remains visible via compact sticky summary plus expandable detail panel."
  artifacts:
    - path: "src/features/ratings/components/WeightsCoveragePanel.tsx"
      provides: "Hybrid sticky summary + expandable details for weights and coverage"
      contains: "warning"
    - path: "src/features/ratings/state/rating.selectors.ts"
      provides: "Weighted coverage and criterion blank-rate calculations"
      contains: "0.7"
    - path: "src/features/ratings/state/ratingPrereq.ts"
      provides: "Shared complete-weights prerequisite helper"
      contains: "weights"
    - path: "src/routes/results/ResultsRoute.tsx"
      provides: "Route guard enforcing weight completeness before results"
      contains: "Navigate"
  key_links:
    - from: "src/features/ratings/components/WeightsCoveragePanel.tsx"
      to: "src/features/ratings/state/rating.selectors.ts"
      via: "coverage/status rendering"
      pattern: "coverage"
    - from: "src/routes/results/ResultsRoute.tsx"
      to: "src/features/ratings/state/ratingPrereq.ts"
      via: "route guard"
      pattern: "has"
    - from: "src/routes/ratings/RatingsRoute.tsx"
      to: "src/features/ratings/components/RatingsStep.tsx"
      via: "route composition"
      pattern: "RatingsStep"
---

<objective>
Complete Phase 3 weight assignment, weighted coverage visibility, and guard wiring so users cannot reach results with incomplete weighting and can interpret missing-data risk inline.

Purpose: Enforce scoring integrity by pairing integer-weight completeness gates with always-visible coverage status and humane warnings before results.
Output: Ratings UI additions for weights/coverage plus ratings/results guard updates using shared prerequisite helpers.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ratings-weights-and-coverage-integrity/03-CONTEXT.md
@.planning/phases/03-ratings-weights-and-coverage-integrity/03-RESEARCH.md
@src/features/ratings/state/rating.selectors.ts
@src/routes/ratings/RatingsRoute.tsx
@src/routes/results/ResultsRoute.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add integer weights and hybrid weighted-coverage panel with inline warnings</name>
  <files>src/features/ratings/components/WeightsCoveragePanel.tsx, src/features/ratings/components/RatingsStep.tsx, src/features/ratings/state/rating.selectors.ts</files>
  <action>Add criterion weight inputs that accept integers only and expose assignment completeness state inline. Implement the locked hybrid layout: compact sticky summary (always visible status) plus expandable detail panel for deeper diagnostics. Surface per-option weighted coverage percentages and severity bands using locked thresholds (`&lt;70%` warning, `&lt;50%` strong warning). Add criterion-level soft warning for high blank rates (use a single configurable threshold constant set to `&gt;30%` blanks by default because exact value is unspecified). Keep key status and warnings inline in the ratings screen (not toast-only) and keep styling utilitarian, compact, and phase-scoped (no full-app redesign/system rollout).</action>
  <verify>`bun run lint && bun run build` succeeds; weight fields reject non-integer values; summary/detail panel displays weighted coverage and warning severity for low-coverage options and blank-heavy criteria.</verify>
  <done>Users can assign complete integer weights and immediately understand coverage risk from persistent inline summary + expandable details.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce results gating on complete weights via shared prereq helpers</name>
  <files>src/features/ratings/state/ratingPrereq.ts, src/routes/ratings/RatingsRoute.tsx, src/routes/results/ResultsRoute.tsx</files>
  <action>Use shared ratings gate helpers to block progression to `/results` until all criteria have valid integer weights (WGT-02). Preserve existing option and criteria guards, then layer weights completeness checks in both the ratings progression path and direct `/results` deep links. Provide explicit inline/guard messaging that tells users to finish weights and review coverage before results. Keep guard logic deterministic and schema-backed, matching the existing route-guard architecture.</action>
  <verify>`bun run lint && bun run build` succeeds; navigating to `/results` with missing weights redirects to `/ratings` with clear recovery guidance; assigning all weights allows results access.</verify>
  <done>Results are unreachable without complete weights, and users receive clear recovery direction through shared guard contracts rather than route-specific ad hoc logic.</done>
</task>

</tasks>

<verification>
Run `bun run lint && bun run build`, then validate flow `/ratings -> /results` twice: once with missing weights (must block/redirect) and once with complete integer weights (must allow). Confirm low-coverage warnings remain visible in the ratings panel without relying on transient toasts.
</verification>

<success_criteria>
Phase 3 is complete when weight completeness is enforced before results and users can see weighted coverage plus low-coverage/blank-rate warnings in an always-available inline workflow.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ratings-weights-and-coverage-integrity/03-03-SUMMARY.md`
</output>
