---
phase: 03-ratings-weights-and-coverage-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/ratings/ratings.schema.ts
  - src/features/ratings/ratingsGate.schema.ts
  - src/features/ratings/state/rating.types.ts
  - src/features/ratings/state/rating.actions.ts
  - src/features/ratings/state/rating.selectors.ts
  - src/features/ratings/state/ratingPrereq.ts
  - src/features/decision/state/draft.types.ts
  - src/features/decision/state/draft.reducer.ts
  - src/features/decision/state/draft.storage.ts
autonomous: true
must_haves:
  truths:
    - "Ratings state keeps blank cells as blank until a user explicitly edits or fills them."
    - "All desirability values used in ratings logic are constrained to 1-20 and never 0."
    - "Switching rating_1_20 mode preserves prior input in both numeric and seven-level representations."
    - "Measured criteria derive desirability from raw values with equal-value neutral output of 10.5."
  artifacts:
    - path: "src/features/ratings/state/rating.types.ts"
      provides: "Canonical matrix cell unions, mode types, and mapping constants"
      contains: "rating_1_20"
    - path: "src/features/ratings/state/rating.selectors.ts"
      provides: "Derived desirability, missing-cell analysis, and coverage selectors"
      contains: "10.5"
    - path: "src/features/decision/state/draft.types.ts"
      provides: "DecisionDraft fields for ratings matrix, mode, and criterion weights"
      contains: "criteria"
    - path: "src/features/ratings/ratingsGate.schema.ts"
      provides: "Schema-backed gate contract for complete integer weights"
      contains: "z.object"
  key_links:
    - from: "src/features/decision/state/draft.reducer.ts"
      to: "src/features/ratings/state/rating.actions.ts"
      via: "DraftAction union reducer handling"
      pattern: "rating"
    - from: "src/features/decision/state/draft.storage.ts"
      to: "src/features/ratings/ratings.schema.ts"
      via: "storage hydration validation"
      pattern: "safeParse"
    - from: "src/features/ratings/state/ratingPrereq.ts"
      to: "src/features/ratings/ratingsGate.schema.ts"
      via: "shared gate helper"
      pattern: "ratingsGateSchema"
---

<objective>
Establish Phase 3's semantics-first ratings and weights domain so matrix behaviors, conversions, and readiness gates are deterministic before UI wiring.

Purpose: Prevent silent scoring drift by locking dual-persistence mode switching, measured derivation, missingness handling, and integer-weight gating in shared typed contracts.
Output: New ratings feature domain files plus DecisionDraft reducer/storage integration for ratings matrix, mode state, and weights.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ratings-weights-and-coverage-integrity/03-CONTEXT.md
@.planning/phases/03-ratings-weights-and-coverage-integrity/03-RESEARCH.md
@src/features/decision/state/draft.types.ts
@src/features/decision/state/draft.reducer.ts
@src/features/decision/state/draft.storage.ts
@src/features/criteria/criteria.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build canonical ratings/weights schemas, types, and selectors</name>
  <files>src/features/ratings/ratings.schema.ts, src/features/ratings/ratingsGate.schema.ts, src/features/ratings/state/rating.types.ts, src/features/ratings/state/rating.actions.ts, src/features/ratings/state/rating.selectors.ts, src/features/ratings/state/ratingPrereq.ts</files>
  <action>Create a dedicated ratings domain layer with typed cell contracts keyed by `optionId + criterionId`. For `rating_1_20`, persist both `numericValue` (1-20) and `sevenLevelValue` (fixed 7-label mapping) with `lastEditedMode` to support RAT-08 reversibility. For `numeric_measured`, store raw numeric inputs and derive desirability via selector min/max normalization with `10.5` when all filled raws are equal (RAT-06), while always enforcing desirability domain `1..20` and never `0` (RAT-05). Add selectors for missing-cell review lists, completion %, missing count, per-option weighted coverage, and criterion blank-rate diagnostics. Add shared gate helper(s) backed by Zod for integer weight completeness. Keep constants explicit (including criterion blank-rate soft warning threshold) and avoid component-local ad hoc conversion logic.</action>
  <verify>`bun run lint && bun run build` succeeds; selector/unit-style smoke checks in code confirm equal measured raws return `10.5` and no selector path outputs desirability `0`.</verify>
  <done>Ratings semantics are centralized in shared typed files, with dual-persistence and measured derivation rules implemented exactly once and reusable by routes/components.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ratings domain into DecisionDraft reducer and storage hydration</name>
  <files>src/features/decision/state/draft.types.ts, src/features/decision/state/draft.reducer.ts, src/features/decision/state/draft.storage.ts</files>
  <action>Extend `DecisionDraft` with ratings matrix state, decision-level rating input mode, and criterion weight assignments. Add reducer handling for ratings actions (cell edits, mode switch, explicit fill-missing apply, and weight updates) while preserving immutable action-driven patterns established in earlier phases. Harden `draft.storage.ts` validation so persisted data must satisfy new ratings schemas and integer-weight constraints before hydration. Keep empty cells intentionally blank by default and ensure mode switching never overwrites inactive representation values (dual persistence retained per user decision).</action>
  <verify>`bun run lint && bun run build` succeeds; reloading a persisted draft with ratings fields hydrates correctly, while malformed ratings payloads are rejected and fallback to safe defaults.</verify>
  <done>Reducer-owned draft state now includes validated ratings and weights, ready for UI integration and route gating without introducing implicit imputation or destructive toggles.</done>
</task>

</tasks>

<verification>
Run `bun run lint && bun run build`, then inspect reducer and selector wiring to confirm: (1) dual mode values coexist, (2) measured equal raws derive `10.5`, (3) blank cells remain explicit missing values, and (4) weights gate helper requires integer assignments for all criteria.
</verification>

<success_criteria>
Phase 3 domain integrity is in place when ratings/weights semantics live in shared schema/selector/action contracts and DecisionDraft can persist/hydrate them without violating 1-20 desirability rules.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ratings-weights-and-coverage-integrity/03-01-SUMMARY.md`
</output>
